# Deploy Flutter web app to Firebase Hosting.
# Environment: API keys loaded at runtime from .env locally; in CI keys come from GitHub Secrets
# via --dart-define at build time.
#
# Required GitHub Secrets:
#   FIREBASE_OPTIONS_KEY, FIREBASE_APP_ID  - Firebase web config
#   FIREBASE_TOKEN                         - From: firebase login:ci (for deploy)
#   Spotify:     CLIENT_ID, CLIENT_SECRET  (or SPOTIFY_CLIENT_ID, SPOTIFY_CLIENT_SECRET)
#   News:        NEWS_API_KEY
#   OpenAI:      OPENAI_API_KEY
#   Unsplash:    UNSPLASH_ACCESS_KEY, UNSPLASH_SECRET

name: Deploy to Firebase Hosting

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build web (release) with API keys from secrets
        env:
          FIREBASE_OPTIONS_KEY: ${{ secrets.FIREBASE_OPTIONS_KEY }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          UNSPLASH_SECRET: ${{ secrets.UNSPLASH_SECRET }}
        run: |
          # Verify required Firebase secrets are set
          if [ -z "$FIREBASE_OPTIONS_KEY" ] || [ -z "$FIREBASE_APP_ID" ]; then
            echo "❌ Error: FIREBASE_OPTIONS_KEY or FIREBASE_APP_ID secrets are not set"
            echo "Please add these secrets in: Settings → Secrets and variables → Actions"
            exit 1
          fi
          
          # Verify keys are not empty (basic check)
          if [ "$FIREBASE_OPTIONS_KEY" = "" ] || [ "$FIREBASE_APP_ID" = "" ]; then
            echo "❌ Error: FIREBASE_OPTIONS_KEY or FIREBASE_APP_ID are empty"
            exit 1
          fi
          
          # Build the dart-define arguments (properly quoted for values with special characters)
          DART_DEFINES=(
            "--dart-define=FIREBASE_OPTIONS_KEY=${FIREBASE_OPTIONS_KEY}"
            "--dart-define=FIREBASE_APP_ID=${FIREBASE_APP_ID}"
          )
          
          # Add optional keys if they are set (non-empty)
          if [ -n "$CLIENT_ID" ] && [ "$CLIENT_ID" != "" ]; then
            DART_DEFINES+=("--dart-define=CLIENT_ID=${CLIENT_ID}")
            echo "✅ CLIENT_ID will be included in build"
          else
            echo "⚠️  CLIENT_ID is not set (optional) - Spotify features may not work"
          fi
          
          if [ -n "$CLIENT_SECRET" ] && [ "$CLIENT_SECRET" != "" ]; then
            DART_DEFINES+=("--dart-define=CLIENT_SECRET=${CLIENT_SECRET}")
            echo "✅ CLIENT_SECRET will be included in build"
          else
            echo "⚠️  CLIENT_SECRET is not set (optional) - Spotify features may not work"
          fi
          
          if [ -n "$NEWS_API_KEY" ] && [ "$NEWS_API_KEY" != "" ]; then
            DART_DEFINES+=("--dart-define=NEWS_API_KEY=${NEWS_API_KEY}")
            echo "✅ NEWS_API_KEY will be included in build"
          else
            echo "⚠️  NEWS_API_KEY is not set (optional) - News features may not work"
          fi
          
          if [ -n "$OPENAI_API_KEY" ] && [ "$OPENAI_API_KEY" != "" ]; then
            DART_DEFINES+=("--dart-define=OPENAI_API_KEY=${OPENAI_API_KEY}")
            echo "✅ OPENAI_API_KEY will be included in build"
          else
            echo "⚠️  OPENAI_API_KEY is not set (optional) - OpenAI features may not work"
          fi
          
          if [ -n "$UNSPLASH_ACCESS_KEY" ] && [ "$UNSPLASH_ACCESS_KEY" != "" ]; then
            DART_DEFINES+=("--dart-define=UNSPLASH_ACCESS_KEY=${UNSPLASH_ACCESS_KEY}")
            echo "✅ UNSPLASH_ACCESS_KEY will be included in build"
          else
            echo "⚠️  UNSPLASH_ACCESS_KEY is not set (optional) - Unsplash features may not work"
          fi
          
          if [ -n "$UNSPLASH_SECRET" ] && [ "$UNSPLASH_SECRET" != "" ]; then
            DART_DEFINES+=("--dart-define=UNSPLASH_SECRET=${UNSPLASH_SECRET}")
            echo "✅ UNSPLASH_SECRET will be included in build"
          else
            echo "⚠️  UNSPLASH_SECRET is not set (optional) - Unsplash features may not work"
          fi
          
          echo "✅ Building web app with API keys..."
          flutter build web --release "${DART_DEFINES[@]}"

      - name: Deploy to Firebase Hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          if [ -z "$FIREBASE_TOKEN" ]; then
            echo "❌ Error: FIREBASE_TOKEN secret is not set in GitHub Secrets"
            echo "To get a token, run: firebase login:ci"
            echo "Then add it as a repository secret: Settings → Secrets and variables → Actions → New repository secret"
            exit 1
          fi
          npx firebase-tools deploy --only hosting --non-interactive --token "$FIREBASE_TOKEN"
