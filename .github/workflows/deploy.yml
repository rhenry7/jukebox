# Deploy Flutter web app to Firebase Hosting.
# Environment: API keys loaded at runtime from .env locally; in CI keys come from GitHub Secrets
# via --dart-define at build time.
#
# Required GitHub Secrets:
#   FIREBASE_OPTIONS_KEY, FIREBASE_APP_ID  - Firebase web config
#     (FIREBASE_OPTIONS_KEY can be base64-encoded as FIREBASE_OPTIONS_KEY_B64)
#   FIREBASE_TOKEN                         - From: firebase login:ci (for deploy)
#   Spotify:     SPOTIFY_CLIENT_ID, SPOTIFY_CLIENT_SECRET
#   News:        NEWS_API_KEY
#   OpenAI:      OPENAI_API_KEY
#   Unsplash:    UNSPLASH_ACCESS_KEY, UNSPLASH_SECRET
#
# Note: All secret values are automatically sanitized (newlines removed, quotes escaped)
#       to prevent build failures. For JSON values like FIREBASE_OPTIONS_KEY, consider
#       using base64 encoding: echo -n 'your-json' | base64

name: Deploy to Firebase Hosting

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build web (release) with API keys from secrets
        env:
          FIREBASE_OPTIONS_KEY: ${{ secrets.FIREBASE_OPTIONS_KEY }}
          FIREBASE_OPTIONS_KEY_B64: ${{ secrets.FIREBASE_OPTIONS_KEY_B64 }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          # Support both SPOTIFY_CLIENT_ID and CLIENT_ID (code expects CLIENT_ID from --dart-define)
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          UNSPLASH_SECRET: ${{ secrets.UNSPLASH_SECRET }}
        run: |
          # Sanitize function: removes newlines, escapes quotes, collapses spaces
          # Usage: sanitized_value=$(sanitize "$raw_value")
          sanitize() {
            printf '%s' "$1" | tr -d '\r\n' | sed 's/"/\\"/g' | tr -s ' ' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
          }
          
          # Handle base64-encoded FIREBASE_OPTIONS_KEY if provided
          if [ -n "$FIREBASE_OPTIONS_KEY_B64" ] && [ "$FIREBASE_OPTIONS_KEY_B64" != "" ]; then
            echo "üì¶ Using base64-encoded FIREBASE_OPTIONS_KEY"
            FIREBASE_OPTIONS_KEY=$(echo -n "$FIREBASE_OPTIONS_KEY_B64" | base64 --decode)
          fi
          
          # Verify required Firebase secrets are set
          if [ -z "$FIREBASE_OPTIONS_KEY" ] || [ -z "$FIREBASE_APP_ID" ]; then
            echo "‚ùå Error: FIREBASE_OPTIONS_KEY or FIREBASE_APP_ID secrets are not set"
            echo "Please add these secrets in: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "Note: FIREBASE_OPTIONS_KEY can be provided as base64 via FIREBASE_OPTIONS_KEY_B64"
            echo "  To encode: echo -n 'your-json-value' | base64"
            exit 1
          fi
          
          # Verify keys are not empty (basic check)
          if [ "$FIREBASE_OPTIONS_KEY" = "" ] || [ "$FIREBASE_APP_ID" = "" ]; then
            echo "‚ùå Error: FIREBASE_OPTIONS_KEY or FIREBASE_APP_ID are empty"
            exit 1
          fi
          
          # Sanitize all values before adding to DART_DEFINES array
          SANITIZED_FIREBASE_OPTIONS_KEY=$(sanitize "$FIREBASE_OPTIONS_KEY")
          SANITIZED_FIREBASE_APP_ID=$(sanitize "$FIREBASE_APP_ID")
          
          # Build the dart-define arguments with sanitized values
          DART_DEFINES=(
            "--dart-define=FIREBASE_OPTIONS_KEY=${SANITIZED_FIREBASE_OPTIONS_KEY}"
            "--dart-define=FIREBASE_APP_ID=${SANITIZED_FIREBASE_APP_ID}"
          )
          
          # Add optional keys if they are set (non-empty), sanitizing each value
          # Note: Code expects CLIENT_ID/CLIENT_SECRET from --dart-define
          # Support both SPOTIFY_CLIENT_ID and CLIENT_ID secret names (prefer SPOTIFY_CLIENT_ID if both set)
          SPOTIFY_ID="${SPOTIFY_CLIENT_ID:-$CLIENT_ID}"
          if [ -n "$SPOTIFY_ID" ] && [ "$SPOTIFY_ID" != "" ]; then
            SANITIZED_VALUE=$(sanitize "$SPOTIFY_ID")
            # Pass as CLIENT_ID (what code expects from String.fromEnvironment)
            DART_DEFINES+=("--dart-define=CLIENT_ID=${SANITIZED_VALUE}")
            echo "‚úÖ CLIENT_ID will be included in build"
          else
            echo "‚ö†Ô∏è  SPOTIFY_CLIENT_ID/CLIENT_ID is not set (optional) - Spotify features may not work"
          fi
          
          SPOTIFY_SECRET="${SPOTIFY_CLIENT_SECRET:-$CLIENT_SECRET}"
          if [ -n "$SPOTIFY_SECRET" ] && [ "$SPOTIFY_SECRET" != "" ]; then
            SANITIZED_VALUE=$(sanitize "$SPOTIFY_SECRET")
            # Pass as CLIENT_SECRET (what code expects from String.fromEnvironment)
            DART_DEFINES+=("--dart-define=CLIENT_SECRET=${SANITIZED_VALUE}")
            echo "‚úÖ CLIENT_SECRET will be included in build"
          else
            echo "‚ö†Ô∏è  SPOTIFY_CLIENT_SECRET/CLIENT_SECRET is not set (optional) - Spotify features may not work"
          fi
          
          if [ -n "$NEWS_API_KEY" ] && [ "$NEWS_API_KEY" != "" ]; then
            SANITIZED_VALUE=$(sanitize "$NEWS_API_KEY")
            DART_DEFINES+=("--dart-define=NEWS_API_KEY=${SANITIZED_VALUE}")
            echo "‚úÖ NEWS_API_KEY will be included in build"
          else
            echo "‚ö†Ô∏è  NEWS_API_KEY is not set (optional) - News features may not work"
          fi
          
          if [ -n "$OPENAI_API_KEY" ] && [ "$OPENAI_API_KEY" != "" ]; then
            SANITIZED_VALUE=$(sanitize "$OPENAI_API_KEY")
            DART_DEFINES+=("--dart-define=OPENAI_API_KEY=${SANITIZED_VALUE}")
            echo "‚úÖ OPENAI_API_KEY will be included in build"
          else
            echo "‚ö†Ô∏è  OPENAI_API_KEY is not set (optional) - OpenAI features may not work"
          fi
          
          if [ -n "$UNSPLASH_ACCESS_KEY" ] && [ "$UNSPLASH_ACCESS_KEY" != "" ]; then
            SANITIZED_VALUE=$(sanitize "$UNSPLASH_ACCESS_KEY")
            DART_DEFINES+=("--dart-define=UNSPLASH_ACCESS_KEY=${SANITIZED_VALUE}")
            echo "‚úÖ UNSPLASH_ACCESS_KEY will be included in build"
          else
            echo "‚ö†Ô∏è  UNSPLASH_ACCESS_KEY is not set (optional) - Unsplash features may not work"
          fi
          
          if [ -n "$UNSPLASH_SECRET" ] && [ "$UNSPLASH_SECRET" != "" ]; then
            SANITIZED_VALUE=$(sanitize "$UNSPLASH_SECRET")
            DART_DEFINES+=("--dart-define=UNSPLASH_SECRET=${SANITIZED_VALUE}")
            echo "‚úÖ UNSPLASH_SECRET will be included in build"
          else
            echo "‚ö†Ô∏è  UNSPLASH_SECRET is not set (optional) - Unsplash features may not work"
          fi
          
          echo "‚úÖ Building web app with ${#DART_DEFINES[@]} API key definitions..."
          flutter build web --release "${DART_DEFINES[@]}"

      - name: Deploy to Firebase Hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          if [ -z "$FIREBASE_TOKEN" ]; then
            echo "‚ùå Error: FIREBASE_TOKEN secret is not set in GitHub Secrets"
            echo "To get a token, run: firebase login:ci"
            echo "Then add it as a repository secret: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            exit 1
          fi
          npx firebase-tools deploy --only hosting --non-interactive --token "$FIREBASE_TOKEN"
